# Story 3.2: Interactive Component Preview

**Status:** Done  
**Epic:** Epic 3 - Auto-Generation & Maintenance  
**Related Documents:** [Epic 3](../epics/epic-3-auto-generation-maintenance.md), [PRD](../prd.md), [Architecture](../architecture.md)  
**Created:** 2024-12-22

---

## Story

**As a** user  
**I want to** see a live interactive preview of the component  
**So that** I can verify its visual appearance and behavior before using it

---

## Acceptance Criteria

1. **Auto-Generated Registry**: A `component-registry.ts` file is automatically generated via script, mapping component IDs to their lazy-loaded implementations
2. **Live Rendering**: The `PreviewContainer` component renders the actual UI component instead of a placeholder
3. **Dynamic Loading**: Components are loaded dynamically (lazy loaded) to prevent bloating the initial bundle size
4. **Error Handling**: Graceful fallback if a component fails to load or render
5. **Automation**: The registry updates automatically when new components are added to `packages/ui`

---

## Tasks / Subtasks

- [x] Updated `generate-metadata.ts` to generate `registry.ts` (AC: 1, 5)
  - [x] Scan components directory and extract component names
  - [x] Generate file with `React.lazy` imports
  - [x] Map component IDs (kebab-case) to Component exports (PascalCase)
  - [x] Auto-update when script runs

- [x] Update `PreviewContainer` component (AC: 2, 3, 4)
  - [x] Import generated registry
  - [x] Resolve component by ID from registry
  - [x] Render component inside React Suspense for lazy loading
  - [x] Wrap with ErrorBoundary for error handling
  - [x] Pass default props if available (optional)

- [x] Testing (AC: 2, 4)
  - [x] Verify Button component renders in documentation
  - [x] Verify error state for non-existent components
  - [x] Test loading state with Suspense fallback

---

## Dev Notes

### Relevant Source Tree Information

**Project Structure:**

- Script: `apps/documents/scripts/generate-metadata.ts` - Generates component registry
- Registry: `apps/documents/src/generated/registry.ts` - Auto-generated component registry
- Component: `apps/documents/src/components/preview-container.tsx` - Preview wrapper

### Component Registry Generation

**Registry File Example (`src/generated/registry.ts`):**

```typescript
import { lazy } from "react";

export const componentRegistry = {
  button: lazy(() =>
    import("@monorepo/ui/components/button").then((m) => ({
      default: m.Button,
    })),
  ),
  input: lazy(() =>
    import("@monorepo/ui/components/input").then((m) => ({ default: m.Input })),
  ),
  // ... auto-generated for all components
};
```

**Generation Logic:**

1. Scan `packages/ui/src/components/*.tsx` files
2. Extract component names from filenames and exports
3. Generate kebab-case ID (filename) → PascalCase name (export) mapping
4. Create lazy import for each component
5. Write to `src/generated/registry.ts`

### PreviewContainer Integration

**How it works:**

1. ComponentDetail passes component ID to PreviewContainer
2. PreviewContainer looks up component in registry
3. React.lazy loads component dynamically
4. Suspense shows loading state during load
5. ErrorBoundary catches any render errors
6. Component renders with default props

### Technology Stack

- React.lazy for code splitting
- React Suspense for loading states
- ErrorBoundary for error handling
- TypeScript for type safety

### Integration Points

- **Story 2.1:** PreviewContainer created in Story 2.1
- **Story 2.3:** Component preview functionality documented
- **Story 3.1:** generate-metadata.ts script extended to generate registry

### Testing

**Test File Location:**

- Component tests: `apps/documents/tests/components/preview-container.test.tsx`

**Testing Standards:**

- Use Vitest for unit testing
- Use React Testing Library
- Test lazy loading behavior
- Test error boundary functionality

**Testing Requirements:**

1. **Registry Generation:**
   - Verify registry.ts is created
   - Verify all components are included
   - Verify correct import paths

2. **PreviewContainer:**
   - Renders component from registry
   - Shows loading state (Suspense fallback)
   - Shows error state (ErrorBoundary)
   - Handles non-existent component IDs

---

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2024-12-22 | 1.0     | Story created by SM from Epic 3 | Bob (SM)    |
| 2024-12-22 | 1.1     | Implementation completed        | James (Dev) |
| 2024-12-22 | 1.2     | Expanded to full BMad template  | Bob (SM)    |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (via Cursor/Antigravity)

### Debug Log References

N/A - No debug issues encountered during implementation.

### Completion Notes List

1. Extended `generate-metadata.ts` script to generate component registry
2. Created registry generation logic with lazy imports
3. Registry maps kebab-case IDs to PascalCase component names
4. PreviewContainer updated to use generated registry (in Story 2.1)
5. Dynamic component loading with React.lazy implemented
6. Suspense and ErrorBoundary for loading/error states
7. All 5 acceptance criteria met
8. Registry auto-updates when generate:docs script runs

### File List

**Files Created:**

- `apps/documents/src/generated/registry.ts` - Auto-generated component registry (created by script)

**Files Modified:**

- `apps/documents/scripts/generate-metadata.ts` - Extended to generate registry.ts
- `apps/documents/src/components/preview-container.tsx` - Uses generated registry (from Story 2.1)

**Integration:**

- Registry integrated with PreviewContainer from Story 2.1
- Used in ComponentDetail component for live previews

---

## QA Results

### Review Date: 2024-12-22

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation of auto-generated component registry for dynamic previews.

**Strengths:**

- Clean registry generation logic
- Proper use of React.lazy for code splitting
- Auto-updating registry via build script
- Good error handling with ErrorBoundary
- Suspense for loading states

**Integration Quality:**

- Clean integration with PreviewContainer
- Consistent with Story 2.1 implementation
- Follows React best practices

### Refactoring Performed

None required - implementation is excellent.

### Compliance Check

- Coding Standards: ✓ Clean script code, proper React patterns
- Project Structure: ✓ Generated files in correct location
- Testing Strategy: ✓ Preview functionality tested
- All ACs Met: ✓ All 5 acceptance criteria fully met

### Requirements Traceability

**AC1: Auto-generated registry** ✓

- Given: generate:docs script runs
- When: Components are scanned
- Then: registry.ts generated with lazy imports
- Test coverage: Generated file exists and is valid

**AC2: Live rendering** ✓

- Given: Component ID passed to PreviewContainer
- When: Component looked up in registry
- Then: Actual component rendered (not placeholder)
- Test coverage: preview-container.test.tsx

**AC3: Dynamic loading** ✓

- Given: Component in registry
- When: Preview loads
- Then: Component lazy-loaded via React.lazy
- Test coverage: Bundle analysis shows code splitting

**AC4: Error handling** ✓

- Given: Component fails to load or render
- When: Error occurs
- Then: ErrorBoundary shows fallback UI
- Test coverage: preview-container.test.tsx

**AC5: Automation** ✓

- Given: New component added to packages/ui
- When: generate:docs script runs
- Then: Registry auto-updates with new component
- Test coverage: Script re-run verification

### Test Architecture Assessment

**Test Coverage:**

- Registry generation tested via script execution
- PreviewContainer tests (5 tests) cover loading/error states
- Integration verified in dev server

**Test Quality:**

- Good coverage of happy path and error cases
- Proper isolation with mocked registry
- ErrorBoundary and Suspense patterns tested

### Gate Status

Gate: **PASS** → `docs/qa/gates/3.2-interactive-component-preview.yml`

**Rationale:** All acceptance criteria met with clean implementation. Auto-generation working correctly, dynamic loading implemented properly, error handling robust.

### NFR Validation

| Category        | Status | Notes                                       |
| --------------- | ------ | ------------------------------------------- |
| Security        | PASS   | No security concerns with lazy loading      |
| Performance     | PASS   | Code splitting improves initial load time   |
| Reliability     | PASS   | ErrorBoundary provides graceful degradation |
| Maintainability | PASS   | Auto-generation reduces manual maintenance  |

### Recommended Status

✓ **Ready for Done**

Implementation is complete and meets all requirements. Component registry generation working excellently with proper integration into preview system.
