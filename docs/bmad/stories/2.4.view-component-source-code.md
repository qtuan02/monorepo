# Story 2.4: View Component Source Code

**Status:** Done  
**Epic:** Epic 2 - Component/Hook Detail Pages  
**Related Documents:** [Epic 2](../epics/epic-2-component-hook-detail-pages.md), [PRD](../prd.md), [Architecture](../architecture.md)  
**Created:** 2024-12-22

---

## Story

**As a** developer  
**I want to** view the full source code of a component  
**So that** I can understand implementation details

---

## Acceptance Criteria

1. Source code is displayed with syntax highlighting
2. Code is properly formatted
3. Line numbers are optional (toggle)
4. Copy to clipboard button is prominent
5. Code viewer handles files up to 500 lines smoothly
6. Full component file is shown (not truncated)

---

## Tasks / Subtasks

- [x] Create CodeViewer component (AC: 1, 2, 3, 4, 5, 6)
  - [x] Create `code-viewer.tsx` in `src/components/`
  - [x] Integrate syntax highlighting (basic highlighting in Story 2.1, full Shiki in Epic 3)
  - [x] Display full component source code (not truncated)
  - [x] Add line numbers toggle button
  - [x] Add copy to clipboard button (prominent placement)
  - [x] Handle files up to 500 lines smoothly (max-height with scroll)
  - [x] Ensure proper code formatting

- [x] Display source code in component detail page (AC: 1, 6)
  - [x] Add source code section to ComponentDetail component
  - [x] Pass component.sourceCode to CodeViewer
  - [x] Label section clearly as "Source Code"

- [x] Implement copy to clipboard (AC: 4)
  - [x] Use Clipboard API with fallback
  - [x] Show toast notification on successful copy
  - [x] Handle copy errors gracefully
  - [x] Preserve code formatting when copying

- [x] Write tests
  - [x] Unit tests for CodeViewer component
  - [x] Test copy to clipboard functionality
  - [x] Test line numbers toggle
  - [x] Test handling of large code blocks
  - [x] Test empty source code handling

---

## Dev Notes

### Relevant Source Tree Information

**Project Structure:**

- Components: `apps/documents/src/components/code-viewer.tsx`
- Tests: `apps/documents/tests/components/code-viewer.test.tsx`

**Key Files:**

- `apps/documents/src/components/code-viewer.tsx` - Code viewer component
- `apps/documents/src/components/component-detail.tsx` - Uses CodeViewer for source code display

### Component Architecture

**CodeViewer Component:**

```typescript
interface CodeViewerProps {
  code: string;
  language?: string; // Default: "typescript"
  showLineNumbers?: boolean; // Default: false
  maxHeight?: string; // Default: "500px"
  className?: string;
}
```

- Displays code with syntax highlighting
- Optional line numbers toggle
- Copy to clipboard button
- Handles large files with scrollable container (max-height constraint)

### Technology Stack

- React 18+ for UI
- Clipboard API for copy functionality
- Basic syntax highlighting (CSS-based, full Shiki deferred to Epic 3)
- Tailwind CSS for styling

### Coding Standards

- File name: `code-viewer.tsx` (kebab-case)
- Component name: `CodeViewer` (PascalCase)
- Use `data-testid` for testing

### Integration Points

- **Story 2.1:** CodeViewer created and used in ComponentDetail
- **Epic 3:** Full Shiki syntax highlighting to be added later

### Testing

**Test File Location:**

- `apps/documents/tests/components/code-viewer.test.tsx`

**Testing Requirements:**

1. Renders code correctly
2. Copy button works (mocked Clipboard API)
3. Line numbers toggle works
4. Handles large code blocks (500+ lines)
5. Handles empty code gracefully
6. Toast notification shows on successful copy

**Test Patterns:**

- Mock `navigator.clipboard.writeText`
- Use `data-testid="code-viewer"` and `data-testid="copy-button"`
- Test line number toggle state

---

## Change Log

| Date       | Version | Description                                    | Author   |
| ---------- | ------- | ---------------------------------------------- | -------- |
| 2024-12-22 | 1.0     | Story created by SM from Epic2                 | Bob (SM) |
| 2024-12-22 | 1.1     | Marked Done - implemented as part of Story 2.1 | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (via Cursor/Antigravity)

### Completion Notes List

**Note:** This story was implemented as part of Story 2.1 (View Component Details).

1. Created `CodeViewer` component in Story 2.1
2. Implemented copy to clipboard with Clipboard API
3. Added line numbers toggle functionality
4. Handles files up to 500 lines with max-height + scroll
5. Full source code display (not truncated)
6. All 6 acceptance criteria fully met
7. Test coverage: 10 tests for CodeViewer in Story 2.1

### File List

**Files Created in Story 2.1:**

- `apps/documents/src/components/code-viewer.tsx` - Code viewer component
- `apps/documents/tests/components/code-viewer.test.tsx` - Component tests (10 tests)

---

## QA Results

### Review Date: 2024-12-22

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent code viewer implementation with robust features and comprehensive test coverage.

**Strengths:**

- Clean implementation of copy to clipboard
- Line numbers toggle provides good UX
- Handles large files efficiently with max-height constraint
- Good error handling for clipboard failures
- Comprehensive test coverage (10 tests)

### Compliance Check

- Coding Standards: ✓ Follows coding conventions
- Project Structure: ✓ Files in correct locations
- Testing Strategy: ✓ Comprehensive unit tests
- All ACs Met: ✓ All 6 acceptance criteria fully implemented

### Requirements Traceability

All 6 acceptance criteria verified and tested:

1. ✓ Syntax highlighting implemented
2. ✓ Code properly formatted
3. ✓ Line numbers toggle works
4. ✓ Copy button prominent and functional
5. ✓ Handles 500+ line files smoothly
6. ✓ Full file shown (not truncated)

### Gate Status

Gate: **PASS** → `docs/qa/gates/2.4-view-component-source-code.yml`

### NFR Validation

| Category        | Status | Notes                                   |
| --------------- | ------ | --------------------------------------- |
| Security        | PASS   | Proper escaping, no XSS vulnerabilities |
| Performance     | PASS   | Efficient rendering with max-height     |
| Reliability     | PASS   | Error handling for clipboard API        |
| Maintainability | PASS   | Clean code, well-tested                 |

### Recommended Status

✓ **Ready for Done**
